passcode:
  alias: "00 âš« Passcode"
  icon: mdi:circle
  variables:
    toggle:
      server:
        passcode: !secret passcode_server
        entity: switch.bureau_martijn_2
  sequence:
    - alias: "action"
      choose:
        - conditions: "{{ action == 'input' }}"
          sequence:
            - service: input_text.set_value
              target:
                entity_id: input_text.passcode
              data:
                value: >
                  {%- set p = states('input_text.passcode') %}
                  {%- if number is defined %}
                    {{ p ~ number if p | count < 4 else p }}
                  {%- else %}
                    {{ iif(p, p[0:-1], '') }}
                  {%- endif %}
        - conditions: "{{ action == 'toggle' }}"
          sequence:
            - if: "{{ states('input_text.passcode') | int == toggle[what].passcode }}"
              then:
                - alias: "Green"
                  service: input_select.select_option
                  target:
                    entity_id: input_select.passcode_color
                  data:
                    option: green
                - delay: 0.5
                - alias: "Close popup"
                  service: browser_mod.close_popup
                - alias: "Remove pass"
                  service: input_text.set_value
                  target:
                    entity_id: input_text.passcode
                  data:
                    value: ""
                - alias: "Toggle"
                  service: homeassistant.toggle
                  target:
                    entity_id: "{{ toggle[what].entity }}"
                - alias: "Blue"
                  service: input_select.select_option
                  target:
                    entity_id: input_select.passcode_color
                  data:
                    option: blue
              else:
                - alias: "Red"
                  service: input_select.select_option
                  target:
                    entity_id: input_select.passcode_color
                  data:
                    option: red
                - delay: 0.5
                - alias: "Remove pass"
                  service: input_text.set_value
                  target:
                    entity_id: input_text.passcode
                  data:
                    value: ""
                - alias: "Blue"
                  service: input_select.select_option
                  target:
                    entity_id: input_select.passcode_color
                  data:
                    option: blue
