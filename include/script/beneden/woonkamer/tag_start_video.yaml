script_start_video_tag:
  alias: "Beneden | Woonkamer - Start video met tag"
  icon: mdi:movie
  mode: restart
  max_exceeded: silent
  sequence:
    - alias: "TV al aan?"
      choose:
        - conditions:
            - alias: "TV uit?"
              condition: state
              entity_id: remote.woonkamer
              state: "off"
          sequence:
            - service: remote.turn_on
              target:
                entity_id: remote.woonkamer
    - alias: "Wachten tot TV aan staat"
      wait_template: >
        {{ 
          (not is_state('media_player.nvidia_shield', 'off')) 
          and (not is_state('media_player.nvidia_shield', 'unavailalbe')) 
        }}
    - alias: "Speel het ingestelde aantal videos"
      repeat:
        count: "{{ number_of_plays }}"
        sequence:
          - variables:
              playlist: "{{ range(0,media|count) | list }}"
              exclude_list: "{{ states(input_text).split('|') | map('int') | list }}"
              to_play: "{{ playlist|reject('in', exclude_list) | list | random }}"
          - alias: "Eerste liedje in input_text weghalen, en nieuwe toevoegen"
            service: input_text.set_value
            target:
              entity_id: "{{ input_text }}"
            data:
              value: "{{ ((states(input_text).split('|') | map('int') | list)[1:] + [to_play]) | join('|') }}"
          - service: media_player.play_media
            target:
              entity_id: "{{ player }}"
            data:
              media_content_id: "{{ media[to_play] | replace('/media', 'media-source://media_source/local') }}"
              media_content_type: "video/mp4"
          - alias: "Pauze om er zeker van te zijn dat de video aan het afspelen is"
            delay: 10
          - alias: "Even wachten tot de video klaar is"
            wait_template: >
              {{
                is_state(player, 'idle')
                or is_state(player, 'off')
              }}
    - service: remote.turn_off
      target:
        entity_id: remote.woonkamer
